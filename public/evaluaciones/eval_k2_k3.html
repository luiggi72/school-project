<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación K2 a K3</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <style>
        html, body { background-color: #f3f4f6; padding: 20px; overflow-y: auto !important; height: auto !important; }
        .container { max-width: 900px; margin: 0 auto 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #111827; margin-bottom: 30px; font-weight: 700; }
        h2 { color: #4f46e5; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-top: 40px; margin-bottom: 20px; font-size: 1.5rem; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 500; margin-bottom: 5px; color: #374151; }
        input[type="text"], input[type="date"], textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Outfit', sans-serif; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        th.center, td.center { text-align: center; }
        .legend { color: #6b7280; font-style: italic; margin-bottom: 15px; font-size: 0.95rem; margin-top: -15px; }
        .btn-submit { display: block; width: 100%; background-color: #4f46e5; color: white; font-weight: 600; text-align: center; padding: 15px; border-radius: 8px; border: none; cursor: pointer; font-size: 1.1rem; margin-top: 30px; }
        .btn-submit:hover { background-color: #4338ca; }
    </style>
</head>
<body>
<div class="container">
    <h1>Evaluación K2 a K3</h1>
    <form id="evaluationForm">
        <div class="grid grid-cols-2 gap-4" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group"><label>Nombre del Alumno:</label><input type="text" name="student_name" required></div>
            <div class="form-group"><label>Fecha de Aplicación:</label><input type="date" name="application_date" required></div>
            
            <div class="form-group"><label>Escuela de Procedencia:</label><input type="text" name="previous_school"></div>
        </div>
        <h2>Indicadores Español</h2><p class="legend">L = Logrado | LD = Logrado con Dificultad | NL = No Logrado</p><table><thead><tr><th style="width: 60%">Indicador</th><th class="center">L</th><th class="center">LD</th><th class="center">NL</th></tr></thead><tbody id="table_spanish"></tbody></table><h2>Indicadores Inglés</h2><table><thead><tr><th style="width: 60%">Indicador</th><th class="center">L</th><th class="center">LD</th><th class="center">NL</th></tr></thead><tbody id="table_english"></tbody></table><div class="form-group"><label>Observaciones:</label><textarea name="english_observations" rows="3"></textarea></div><h2>Indicadores Psico</h2><p class="legend">L = Logrado | EP = En Proceso | NA = Necesita Ayuda</p><table><thead><tr><th style="width: 60%">Indicador</th><th class="center">L</th><th class="center">EP</th><th class="center">NA</th></tr></thead><tbody id="table_psycho"></tbody></table><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"><div class="form-group"><label>Nivel de Desarrollo:</label><input type="text" name="nivel_desarrollo"></div><div class="form-group"><label>Indicadores Madurez Visomotora:</label><input type="text" name="indicadores_madurez"></div><div class="form-group"><label>Indicadores Emocionales:</label><input type="text" name="indicadores_emocionales"></div></div><div class="form-group"><label>Observaciones:</label><textarea name="psycho_observations" rows="3"></textarea></div>
        <button type="submit" class="btn-submit">Guardar Evaluación</button>
    </form>
</div>
<script>
    const indicators = {
        spanish: ["Comprende y responde preguntas sobre textos simples","Resuelve problemas a través del conteo y con acciones sobre las colecciones","Comunica de manera oral y escrita los números del 1 al 10","Cuenta colecciones no mayores a 20 elementos","Compara, iguala y clasifica colecciones con base en la cantidad de elementos","Relaciona el número de elementos de una colección con la sucesión numérica escrita","Ubica objetos y lugares cuya ubicación desconoce, a través de la interpretación de relaciones espaciales","Reconoce figuras y cuerpos geométricos","Identifica colores primarios, secundarios y terciarios","Identifica varios eventos de su vida cotidiana y dice el orden en que ocurren","Escribe su nombre","Sigue instrucciones con fluidez"],
        english: ["Identifica figuras básicas","Identifica colores primarios, secundarios y terciarios","Domina vocabulario simple partes del cuerpo","Domina vocabulario simple familia","Domina vocabulario simple clima","Domina vocabulario simple objetos dentro del aula","Cuenta del 1 al 10 en inglés","Conoce el nombre de las letras","Identifica conceptos espaciales simples","Escucha y contesta frases sencillas","Sigue instrucciones simples como señalar"],
        psycho: ["Identifica y reconoce las emociones básicas en él y los demás","Mantiene seguimiento de instrucciones cortas de forma auditiva y verbal","Sus periodos de atención son los esperados a la etapa de desarrollo (5-15 min)","Tiene control y autorregulación corporal durante el tiempo de trabajo","Mantiene la rutina y ritmo de trabajo conforme a la media del grupo","Tiene un lenguaje espontáneo y una articulación regular de fonemas","Toma adecuadamente el lápiz/crayola para iniciar una actividad","Solicita apoyo a los adultos cuando tiene una necesidad","Se relaciona positivamente con su entorno (compañeros y docentes)","Coordina movimientos de extremidades y mantiene un propiocepción adecuada"],
    };

    function generateRows(tableId, items, prefix, values) {
        const tbody = document.getElementById(tableId);
        items.forEach((item, index) => {
            const tr = document.createElement('tr');
            const name = prefix + '_' + index;
            let cells = '<td>' + item + '</td>';
            values.forEach(val => {
                cells += '<td class="center"><input type="radio" name="' + name + '" value="' + val + '" required></td>';
            });
            tr.innerHTML = cells;
            tbody.appendChild(tr);
        });
    }

        generateRows('table_spanish', indicators.spanish, 'spanish', ["L","LD","NL"]);
    generateRows('table_english', indicators.english, 'english', ["L","LD","NL"]);
    generateRows('table_psycho', indicators.psycho, 'psycho', ["L","EP","NA"]);


    document.getElementById('evaluationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const collectIndicators = (count, prefix) => {
            const arr = [];
            for(let i=0; i<count; i++) arr.push(formData.get(prefix + '_' + i) || null);
            return arr;
        };

        const payload = {
            student_name: formData.get('student_name'),
            application_date: formData.get('application_date'),
            previous_school: formData.get('previous_school'),
            spanish_indicators: collectIndicators(indicators.spanish.length, 'spanish'),
            english_indicators: collectIndicators(indicators.english.length, 'english'),
            english_observations: formData.get('english_observations'),
            psycho_indicators: collectIndicators(indicators.psycho.length, 'psycho'),
            psycho_observations: formData.get('psycho_observations'),
            nivel_desarrollo: formData.get('nivel_desarrollo'),
            indicadores_madurez: formData.get('indicadores_madurez'),
            indicadores_emocionales: formData.get('indicadores_emocionales'),

        };

        try {
            const token = localStorage.getItem('token');
            const res = await fetch('/api/eval_k2_k3', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) { alert('Guardado correctamente!'); window.location.reload(); }
            else { alert('Error: ' + data.error); }
        } catch (err) { console.error(err); alert('Error de conexión'); }
    });
    
    document.querySelector('input[name="application_date"]').valueAsDate = new Date();
</script>
</body>
</html>